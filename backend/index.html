<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PlantAI ‚Äî Plant Disease Detector</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-green-50 font-sans leading-normal text-gray-800">
  <!-- NAV -->
  <nav class="bg-green-700 text-white sticky top-0 z-50 shadow">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="text-2xl font-bold">üå± PlantAI</div>
        <div class="hidden md:flex gap-4 text-sm">
          <a href="#home" class="hover:underline">Home</a>
          <a href="#about" class="hover:underline">About</a>
          <a href="#details" class="hover:underline">Details</a>
          <a href="#analyze-section" class="hover:underline">Analyze</a>
          <a href="#tips" class="hover:underline">Tips</a>
          <a href="#history" class="hover:underline" id="nav-history">History</a>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <!-- language selector -->
        <select id="lang-select" class="bg-white text-green-700 px-2 py-1 rounded-md text-sm">
          <option value="en">English</option>
          <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
          <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</option>
          <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
        </select>

        <button id="open-history" class="bg-white text-green-700 px-3 py-1 rounded-md text-sm" data-i18n="ui.history">History</button>
        <a href="#analyze-section" class="bg-white text-green-700 px-3 py-1 rounded-md text-sm" data-i18n="ui.analyze">Analyze</a>
      </div>
    </div>
  </nav>

  <!-- HERO / HOME -->
  <section id="home" class="py-16 text-center bg-green-100">
    <h1 class="text-4xl md:text-5xl font-extrabold text-green-800 mb-4">PlantAI ‚Äî Smart Crop Disease Detection</h1>
    <p class="max-w-3xl mx-auto text-gray-700 text-lg">
      Your smart AI-based prototype to detect crop diseases from leaf images and get simple, actionable remedies. Built with the farmer in mind: intuitive, fast, and practical.
    </p>
    <div class="mt-6">
      <a href="#analyze-section" class="inline-block bg-green-700 text-white px-6 py-3 rounded-full shadow">Get started ‚Äî Analyze a leaf</a>
    </div>
  </section>

  <!-- ABOUT -->
  <section id="about" class="py-12 max-w-4xl mx-auto px-4">
    <h2 class="text-3xl font-bold text-green-700 mb-4 text-center">About PlantAI</h2>
    <p class="text-gray-700 mb-3">
      "Your challenge is to develop a smart AI-based prototype that detects crop diseases from leaf images and suggests simple, actionable remedies for farmers. The system should be intuitive, accurate, and built with the end-user‚Äîthe farmer‚Äîin mind."
    </p>
    <p class="text-gray-700">PlantAI focuses on practical suggestions a farmer can implement quickly: identification, confidence scoring, short remediation steps, and a simple report they can save or share with an advisor.</p>
  </section>

  <!-- DETAILS / HOW IT WORKS -->
  <section id="details" class="py-12 bg-green-100">
    <div class="max-w-5xl mx-auto px-4">
      <h3 class="text-3xl font-bold text-center text-green-700 mb-6">How it works</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl p-6 shadow text-center">
          <h4 class="font-semibold text-green-700 mb-2">1. Capture or Upload</h4>
          <p class="text-sm text-gray-600">Take a clear photo of the leaf or upload from your gallery.</p>
        </div>
        <div class="bg-white rounded-xl p-6 shadow text-center">
          <h4 class="font-semibold text-green-700 mb-2">2. AI Detection</h4>
          <p class="text-sm text-gray-600">Our model analyzes the leaf, identifies possible disease(s), and returns a confidence score.</p>
        </div>
        <div class="bg-white rounded-xl p-6 shadow text-center">
          <h4 class="font-semibold text-green-700 mb-2">3. Simple Remedies</h4>
          <p class="text-sm text-gray-600">Get step-by-step, low-cost recommendations tailored for smallholder farmers.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- ANALYZE SECTION -->
  <section id="analyze-section" class="py-12">
    <div class="max-w-2xl mx-auto px-4">
      <div class="bg-white p-6 rounded-2xl shadow-xl">
        <h2 class="text-2xl font-bold text-green-700 text-center mb-4">üå± <span id="analyze-title">Analyze a Leaf</span></h2>

        <!-- Upload controls -->
        <div id="image-uploader" class="border-2 border-dashed border-green-400 p-6 text-center cursor-pointer rounded-xl bg-green-50">
          <p id="upload-placeholder" class="text-gray-600">Drag & Drop or Click to Upload Image</p>
          <input type="file" id="file-input" class="hidden" accept="image/*" capture="environment">
          <div class="mt-3 text-sm text-gray-500">Or use your device camera (mobile-friendly)</div>
        </div>

        <!-- Preview -->
        <div id="image-preview-container" class="hidden mt-4 text-center">
          <img id="image-preview" class="rounded-lg shadow-md max-h-72 mx-auto" alt="preview">
          <div class="flex justify-between mt-3">
            <button id="remove-image-button" class="bg-red-500 text-white px-4 py-2 rounded-lg" data-i18n="ui.remove">Remove</button>
            <div class="flex gap-2">
              <button id="download-report" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg" data-i18n="ui.downloadReport">Download Report</button>
              <button id="analyze-button" class="bg-green-500 text-white px-4 py-2 rounded-lg" data-i18n="ui.analyze">Analyze</button>
            </div>
          </div>
        </div>

        <!-- Loader -->
        <div id="loader" class="hidden text-center mt-4">‚è≥ <span id="loading-text">Analyzing...</span></div>

        <!-- Result -->
        <div id="result-container" class="hidden mt-4 p-4 border rounded-lg bg-gray-50">
          <div id="result-content"></div>
        </div>

      </div>
    </div>
  </section>

  <!-- Tips & FAQ -->
  <section id="tips" class="py-12 max-w-4xl mx-auto px-4">
    <h3 class="text-2xl font-bold text-green-700 mb-4 text-center" id="tips-title">Practical Tips for Farmers</h3>
    <ul class="list-disc list-inside text-gray-700 space-y-2">
      <li id="tip-1">Inspect leaves weekly to catch disease early.</li>
      <li id="tip-2">Ensure good drainage and avoid overwatering.</li>
      <li id="tip-3">Use recommended organic sprays and rotate crops.</li>
      <li id="tip-4">Keep a photo log: it helps when consulting experts.</li>
    </ul>
  </section>

  <!-- HISTORY (localStorage) -->
  <section id="history" class="py-12 max-w-4xl mx-auto px-4">
    <h3 class="text-2xl font-bold text-green-700 mb-4 text-center" data-i18n="ui.historyTitle">Analysis History</h3>
    <div id="history-list" class="bg-white p-4 rounded-xl shadow text-sm min-h-[80px]">No history yet.</div>
  </section>

  <!-- FOOTER -->
  <footer class="bg-green-700 text-white py-6 mt-8 text-center">
    &copy; 2025 PlantAI. Built for farmers. Simple remedies, stronger harvests.
  </footer>

<script>
/* ---------------- CONFIG ---------------- */
const API_ENDPOINT = "http://127.0.0.1:5000/predict"; // change to deployed URL if needed

/* ---------------- DOM ---------------- */
const dropZone = document.getElementById('image-uploader');
const fileInput = document.getElementById('file-input');
const imagePreviewContainer = document.getElementById('image-preview-container');
const imagePreview = document.getElementById('image-preview');
const analyzeButton = document.getElementById('analyze-button');
const removeImageButton = document.getElementById('remove-image-button');
const loader = document.getElementById('loader');
const resultContainer = document.getElementById('result-container');
const resultContent = document.getElementById('result-content');
const historyList = document.getElementById('history-list');
const openHistoryBtn = document.getElementById('open-history');
const downloadReportBtn = document.getElementById('download-report');
const langSelect = document.getElementById('lang-select');

/* ---------------- TRANSLATIONS ----------------
   Frontend translations for UI and several classes.
   Add more class keys exactly as your model returns (or as the backend's simplified key returns).
*/
const translations = {
  en: {
    ui: {
      analyze: "Analyze",
      history: "History",
      historyTitle: "Analysis History",
      tipsTitle: "Practical Tips for Farmers",
      upload: "Drag & Drop or Click to Upload Image",
      remove: "Remove",
      downloadReport: "Download Report",
      confidence: "Confidence",
      noHistory: "No history yet.",
      noResult: "No analysis result to download.",
      recommendations: "Recommendations"
    },
    classes: {
      "Healthy": {
        name: "Healthy",
        description: "The plant looks healthy (class: Healthy).",
        recommendations: [
          "Continue routine care and monitoring.",
          "Avoid overwatering and ensure good light."
        ]
      },
      "Early_blight": {
        name: "Early Blight",
        description: "Early blight affects leaves and causes spots.",
        recommendations: [
          "Remove infected leaves.",
          "Use recommended fungicide as per label.",
          "Rotate crops next season."
        ]
      }
    },
    generic: {
      healthy: {
        description: "The plant looks healthy.",
        recommendations: [
          "Continue routine care and monitoring.",
          "Avoid overwatering."
        ]
      },
      disease: {
        description: "Predicted disease detected. Please inspect and consider local extension services.",
        recommendations: [
          "Isolate affected plants.",
          "Remove severely infected leaves and dispose safely.",
          "Consult local extension or plant pathology resources for treatment."
        ]
      }
    }
  },

  te: {
    ui: {
      analyze: "‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞ø‡∞Ç‡∞ö‡±Å",
      history: "‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞",
      historyTitle: "‡∞µ‡∞ø‡∞∂‡±ç‡∞≤‡±á‡∞∑‡∞£ ‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞",
      tipsTitle: "‡∞∞‡±à‡∞§‡±Å‡∞≤ ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞Ü‡∞ö‡∞∞‡∞£‡∞æ‡∞§‡±ç‡∞Æ‡∞ï ‡∞∏‡±Ç‡∞ö‡∞®‡∞≤‡±Å",
      upload: "‡∞°‡±ç‡∞∞‡∞æ‡∞ó‡±ç ‡∞ö‡±á‡∞∏‡∞ø ‡∞µ‡∞¶‡∞≤‡∞Ç‡∞°‡∞ø ‡∞≤‡±á‡∞¶‡∞æ ‡∞ö‡∞ø‡∞§‡±ç‡∞∞‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞Ö‡∞™‡±ç‡∞≤‡±ã‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
      remove: "‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡±Å",
      downloadReport: "‡∞∞‡∞ø‡∞™‡±ã‡∞∞‡±ç‡∞ü‡±ç ‡∞°‡±å‡∞®‡±ç‡∞≤‡±ã‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø",
      confidence: "‡∞®‡∞Æ‡±ç‡∞Æ‡∞ï ‡∞∏‡±ç‡∞•‡∞æ‡∞Ø‡∞ø",
      noHistory: "‡∞á‡∞™‡±ç‡∞™‡∞ü‡∞ø ‡∞µ‡∞∞‡∞ï‡±Å ‡∞ö‡∞∞‡∞ø‡∞§‡±ç‡∞∞ ‡∞≤‡±á‡∞¶‡±Å.",
      noResult: "‡∞°‡±å‡∞®‡±ç‡∞≤‡±ã‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞´‡∞≤‡∞ø‡∞§‡∞Ç ‡∞≤‡±á‡∞¶‡±Å.",
      recommendations: "‡∞∏‡±Ç‡∞ö‡∞®‡∞≤‡±Å"
    },
    classes: {
      "Healthy": {
        name: "‡∞Ü‡∞∞‡±ã‡∞ó‡±ç‡∞Ø‡∞Ç‡∞ó‡∞æ ‡∞â‡∞Ç‡∞¶‡∞ø",
        description: "‡∞Æ‡±ä‡∞ï‡±ç‡∞ï ‡∞Ü‡∞∞‡±ã‡∞ó‡±ç‡∞Ø‡∞Ç‡∞ó‡∞æ ‡∞ï‡∞®‡∞ø‡∞™‡∞ø‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø (‡∞µ‡∞∞‡±ç‡∞ó‡∞Ç: Healthy).",
        recommendations: [
          "‡∞∏‡∞æ‡∞ß‡∞æ‡∞∞‡∞£ ‡∞∏‡∞Ç‡∞∞‡∞ï‡±ç‡∞∑‡∞£ ‡∞ï‡±ä‡∞®‡∞∏‡∞æ‡∞ó‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø.",
          "‡∞Ö‡∞ß‡∞ø‡∞ï ‡∞®‡±Ä‡∞∞‡±Å‡∞™‡±ã‡∞∏‡±á ‡∞¶‡∞æ‡∞®‡±ç‡∞®‡∞ø ‡∞®‡∞ø‡∞µ‡∞æ‡∞∞‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø."
        ]
      },
      "Early_blight": {
        name: "‡∞Ö‡∞∞‡∞Ç‡∞≠ ‡∞¨‡±ç‡∞≤‡±à‡∞ü‡±ç",
        description: "‡∞à ‡∞µ‡±ç‡∞Ø‡∞æ‡∞ß‡∞ø ‡∞Ü‡∞ï‡±Å‡∞≤‡±ç‡∞≤‡±ã ‡∞Æ‡∞ö‡±ç‡∞ö‡∞≤‡±Å ‡∞ï‡∞≤‡∞ø‡∞ó‡∞ø‡∞∏‡±ç‡∞§‡±Å‡∞Ç‡∞¶‡∞ø.",
        recommendations: [
          "‡∞≠‡∞æ‡∞ó‡∞æ‡∞≤‡±à‡∞® ‡∞Ü‡∞ï‡±Å‡∞≤‡∞®‡±Å ‡∞§‡±Ä‡∞∏‡∞ø‡∞µ‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.",
          "‡∞≤‡±á‡∞¨‡±Å‡∞≤‡±ç ‡∞™‡±ç‡∞∞‡∞ï‡∞æ‡∞∞‡∞Ç ‡∞´‡∞Ç‡∞ó‡∞ø‡∞∏‡±à‡∞°‡±ç ‡∞µ‡∞æ‡∞°‡∞Ç‡∞°‡∞ø.",
          "‡∞§‡∞≤‡±Å‡∞™‡±Å‡∞≤‡±Å‡∞ó‡∞æ ‡∞™‡∞Ç‡∞ü‡∞®‡±Å ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ö‡∞Ç‡∞°‡∞ø."
        ]
      }
    },
    generic: {
      healthy: {
        description: "‡∞Æ‡±ä‡∞ï‡±ç‡∞ï ‡∞Ü‡∞∞‡±ã‡∞ó‡±ç‡∞Ø‡∞Ç‡∞ó‡∞æ ‡∞â‡∞Ç‡∞¶‡∞ø.",
        recommendations: [
          "‡∞∏‡∞æ‡∞ß‡∞æ‡∞∞‡∞£ ‡∞∏‡∞Ç‡∞∞‡∞ï‡±ç‡∞∑‡∞£ ‡∞ï‡±ä‡∞®‡∞∏‡∞æ‡∞ó‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø.",
          "‡∞Ö‡∞ß‡∞ø‡∞ï ‡∞®‡±Ä‡∞∞‡±Å ‡∞á‡∞µ‡±ç‡∞µ‡∞µ‡∞¶‡±ç‡∞¶‡±Å."
        ]
      },
      disease: {
        description: "‡∞µ‡±ç‡∞Ø‡∞æ‡∞ß‡∞ø ‡∞∏‡±Ç‡∞ö‡∞®‡∞≤‡±Å ‡∞ï‡∞®‡∞ø‡∞™‡∞ø‡∞Ç‡∞ö‡∞æ‡∞Ø‡∞ø. ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞™‡∞∞‡∞ø‡∞∂‡±Ä‡∞≤‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø ‡∞Æ‡∞∞‡∞ø‡∞Ø‡±Å ‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞ø‡∞ï ‡∞®‡∞ø‡∞™‡±Å‡∞£‡±Å‡∞≤‡∞®‡±Å ‡∞∏‡∞Ç‡∞™‡±ç‡∞∞‡∞¶‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø.",
        recommendations: [
          "‡∞™‡±ç‡∞∞‡∞≠‡∞æ‡∞µ‡∞ø‡∞§ ‡∞Æ‡±ä‡∞ï‡±ç‡∞ï‡∞≤‡∞®‡±Å ‡∞µ‡±á‡∞∞‡±Å‡∞ö‡±á‡∞∏‡∞ø ‡∞â‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø.",
          "‡∞≠‡∞æ‡∞∞‡±Ä‡∞ó‡∞æ ‡∞™‡∞æ‡∞°‡±à‡∞® ‡∞Ü‡∞ï‡±Å‡∞≤‡∞®‡±Å ‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡∞ø ‡∞®‡∞æ‡∞∂‡∞®‡∞Ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.",
          "‡∞ö‡∞ø‡∞ï‡∞ø‡∞§‡±ç‡∞∏ ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞ø‡∞ï ‡∞µ‡±ç‡∞Ø‡∞µ‡∞∏‡∞æ‡∞Ø ‡∞∏‡±á‡∞µ‡∞≤‡∞®‡±Å ‡∞∏‡∞Ç‡∞™‡±ç‡∞∞‡∞¶‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø."
        ]
      }
    }
  },

  ta: {
    ui: {
      analyze: "‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç",
      history: "‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ",
      historyTitle: "‡Æ™‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡Ææ‡ÆØ‡Øç‡Æµ‡ØÅ ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ",
      tipsTitle: "‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ‡Æø‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡Ææ‡Æ© ‡Æ®‡Æü‡Øà‡ÆÆ‡ØÅ‡Æ±‡Øà ‡Æï‡ØÅ‡Æ±‡Æø‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Æ≥‡Øç",
      upload: "‡Æ™‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡Æá‡Æ¥‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ ‡Æµ‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç",
      remove: "‡ÆÖ‡Æï‡Æ±‡Øç‡Æ±‡ØÅ",
      downloadReport: "‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Øà ‡Æ™‡Æ§‡Æø‡Æµ‡Æø‡Æ±‡Æï‡Øç‡Æï‡ØÅ",
      confidence: "‡Æ®‡ÆÆ‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Øà",
      noHistory: "‡Æá‡Æ™‡Øç‡Æ™‡Øä‡Æ¥‡ØÅ‡Æ§‡ØÅ ‡Æµ‡Æ∞‡Æ≤‡Ææ‡Æ±‡ØÅ ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà.",
      noResult: "‡Æ™‡Æ§‡Æø‡Æµ‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡Ææ‡Æ© ‡ÆÆ‡ØÅ‡Æü‡Æø‡Æµ‡ØÅ ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà.",
      recommendations: "‡Æ™‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ∞‡Øà‡Æï‡Æ≥‡Øç"
    },
    classes: {
      "Healthy": {
        name: "‡ÆÜ‡Æ∞‡Øã‡Æï‡Øç‡ÆØ‡ÆÆ‡Øç",
        description: "‡Æö‡ØÜ‡Æü‡Æø ‡ÆÜ‡Æ∞‡Øã‡Æï‡Øç‡Æï‡Æø‡ÆØ ‡Æ®‡Æø‡Æ≤‡Øà‡ÆØ‡Æø‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æ§‡ØÅ (‡Æµ‡Æï‡ØÅ‡Æ™‡Øç‡Æ™‡ØÅ: Healthy).",
        recommendations: [
          "‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ®‡Øç‡Æ§ ‡Æ™‡Æ∞‡Ææ‡ÆÆ‡Æ∞‡Æø‡Æ™‡Øç‡Æ™‡Øà ‡Æö‡ØÜ‡ÆØ‡Øç‡ÆØ‡Æµ‡ØÅ‡ÆÆ‡Øç.",
          "‡ÆÖ‡Æ§‡Æø‡Æï ‡Æ®‡ØÄ‡Æ∞‡Øà‡Æ§‡Øç ‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç."
        ]
      }
    },
    generic: {
      healthy: {
        description: "‡Æö‡ØÜ‡Æü‡Æø ‡ÆÜ‡Æ∞‡Øã‡Æï‡Øç‡Æï‡Æø‡ÆØ‡ÆÆ‡Ææ‡Æï ‡Æ§‡ØÜ‡Æ∞‡Æø‡Æï‡Æø‡Æ±‡Æ§‡ØÅ.",
        recommendations: [
          "‡Æ™‡Æ∞‡Ææ‡ÆÆ‡Æ∞‡Æø‡Æ™‡Øç‡Æ™‡Øà ‡Æ§‡Øä‡Æü‡Æ∞‡Æµ‡ØÅ‡ÆÆ‡Øç.",
          "‡ÆÖ‡Æ§‡Æø‡Æï ‡Æ®‡ØÄ‡Æ∞‡Øà ‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç."
        ]
      },
      disease: {
        description: "‡Æ®‡Øã‡ÆØ‡Øç‡Æï‡Øç ‡Æï‡ØÅ‡Æ±‡Æø‡ÆØ‡ØÄ‡Æü‡ØÅ‡Æï‡Æ≥‡Øç ‡Æï‡Æ£‡Øç‡Æü‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü‡Æ©. ‡Æ§‡ÆØ‡Æµ‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡Æ™‡Æ∞‡Æø‡Æö‡ØÄ‡Æ≤‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥‡ØÇ‡Æ∞‡Ææ‡Æ© ‡Æâ‡Æ§‡Æµ‡Æø‡Æï‡Æ≥‡Øà‡Æï‡Øç ‡Æï‡Æ≤‡Æ®‡Øç‡Æ§‡Ææ‡Æ≤‡Øã‡Æö‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.",
        recommendations: [
          "‡Æ™‡Ææ‡Æ§‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æ§‡Ææ‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡Æ§‡Æ©‡Æø‡ÆØ‡Ææ‡Æï ‡Æµ‡Øà‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.",
          "‡ÆÆ‡Æø‡Æï ‡ÆÖ‡Æ§‡Æø‡Æï‡ÆÆ‡Ææ‡Æï ‡Æ™‡Ææ‡Æ§‡Æø‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æá‡Æ≤‡Øà‡Æï‡Æ≥‡Øà ‡ÆÖ‡Æï‡Æ±‡Øç‡Æ±‡Æø ‡ÆÖ‡Æ¥‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.",
          "‡Æö‡Æø‡Æï‡Æø‡Æö‡Øç‡Æö‡Øà‡Æï‡Øç‡Æï‡Ææ‡Æï ‡Æâ‡Æ≥‡Øç‡Æ≥‡ØÇ‡Æ∞‡Ææ‡Æü‡Øç‡Æö‡Æø ‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ ‡Æâ‡Æ§‡Æµ‡Æø‡ÆØ‡Øà ‡ÆÖ‡Æ£‡ØÅ‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç."
        ]
      }
    }
  },

  hi: {
    ui: {
      analyze: "‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç",
      history: "‡§á‡§§‡§ø‡§π‡§æ‡§∏",
      historyTitle: "‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§á‡§§‡§ø‡§π‡§æ‡§∏",
      tipsTitle: "‡§ï‡§ø‡§∏‡§æ‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è ‡§µ‡•ç‡§Ø‡§æ‡§µ‡§π‡§æ‡§∞‡§ø‡§ï ‡§∏‡•Å‡§ù‡§æ‡§µ",
      upload: "‡§ñ‡•Ä‡§Ç‡§ö‡•á‡§Ç ‡§î‡§∞ ‡§õ‡•ã‡§°‡§º‡•á‡§Ç ‡§Ø‡§æ ‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç",
      remove: "‡§π‡§ü‡§æ‡§è‡§Å",
      downloadReport: "‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç",
      confidence: "‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§∏",
      noHistory: "‡§Ö‡§≠‡•Ä ‡§§‡§ï ‡§ï‡•ã‡§à ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§®‡§π‡•Ä‡§Ç‡•§",
      noResult: "‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§",
      recommendations: "‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∂‡•á‡§Ç"
    },
    classes: {
      "Healthy": {
        name: "‡§∏‡•ç‡§µ‡§∏‡•ç‡§•",
        description: "‡§™‡•å‡§ß‡§æ ‡§∏‡•ç‡§µ‡§∏‡•ç‡§• ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á ‡§∞‡§π‡§æ ‡§π‡•à (‡§µ‡§∞‡•ç‡§ó: Healthy).",
        recommendations: [
          "‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤ ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç‡•§",
          "‡§Ö‡§§‡•ç‡§Ø‡§ß‡§ø‡§ï ‡§™‡§æ‡§®‡•Ä ‡§∏‡•á ‡§¨‡§ö‡•á‡§Ç‡•§"
        ]
      }
    },
    generic: {
      healthy: {
        description: "‡§™‡•å‡§ß‡§æ ‡§∏‡•ç‡§µ‡§∏‡•ç‡§• ‡§¶‡§ø‡§ñ‡§§‡§æ ‡§π‡•à‡•§",
        recommendations: [
          "‡§®‡§ø‡§Ø‡§Æ‡§ø‡§§ ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤ ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç‡•§",
          "‡§Ö‡§ß‡§ø‡§ï ‡§™‡§æ‡§®‡•Ä ‡§® ‡§¶‡•á‡§Ç‡•§"
        ]
      },
      disease: {
        description: "‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∞‡•ã‡§ó ‡§ï‡§æ ‡§™‡§§‡§æ ‡§ö‡§≤‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§®‡§ø‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û‡•ã‡§Ç ‡§∏‡•á ‡§∏‡§≤‡§æ‡§π ‡§≤‡•á‡§Ç‡•§",
        recommendations: [
          "‡§™‡•ç‡§∞‡§≠‡§æ‡§µ‡§ø‡§§ ‡§™‡•å‡§ß‡•ã‡§Ç ‡§ï‡•ã ‡§Ö‡§≤‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§",
          "‡§≠‡§æ‡§ú‡•ç‡§Ø ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡§Ç‡§ï‡•ç‡§∞‡§Æ‡§ø‡§§ ‡§™‡§§‡•ç‡§§‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§π‡§ü‡§æ‡§ï‡§∞ ‡§®‡§∑‡•ç‡§ü ‡§ï‡§∞‡•á‡§Ç‡•§",
          "‡§â‡§™‡§ö‡§æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§ï‡•É‡§∑‡§ø ‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞ ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§"
        ]
      }
    }
  }
};

/* ---------------- state ---------------- */
let currentLang = localStorage.getItem('plantai_lang') || navigator.language.split('-')[0] || 'en';
if (!['en','te','ta','hi'].includes(currentLang)) currentLang = 'en';
langSelect.value = currentLang;

let lastServerResult = null; // keep raw server response for re-localization on lang change

/* ---------------- Helpers ---------------- */
function show(el){ el.classList.remove('hidden'); }
function hide(el){ el.classList.add('hidden'); }

function t(key, fallback) {
  const parts = key.split('.');
  const langPack = translations[currentLang] || translations['en'];
  let cur = langPack;
  for (const p of parts) {
    if (!cur || typeof cur !== 'object' || !(p in cur)) {
      // fallback to english complete key if available
      const enPack = translations['en'] || {};
      let encur = enPack;
      for (const q of parts) {
        if (!encur || typeof encur !== 'object' || !(q in encur)) {
          return fallback !== undefined ? fallback : key;
        }
        encur = encur[q];
      }
      return encur;
    }
    cur = cur[p];
  }
  return cur;
}

function applyTranslationsToUI() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const val = t(key);
    if (val) el.textContent = val;
  });
  document.getElementById('upload-placeholder').textContent = t('ui.upload', 'Drag & Drop or Click to Upload Image');
  document.getElementById('analyze-title').textContent = t('ui.analyze', 'Analyze a Leaf');
  document.getElementById('tips-title').textContent = t('ui.tipsTitle', 'Practical Tips for Farmers');
  const tips = t('tips', null);
  if (Array.isArray(tips) && tips.length) {
    tips.forEach((it, idx) => {
      const el = document.getElementById('tip-'+(idx+1));
      if (el) el.textContent = it;
    });
  }
}

/* ---------------- Drag & Click upload ---------------- */
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', handleFileSelect);

function handleFileSelect(){
  const file = fileInput.files[0];
  if (file && file.type.startsWith('image/')){
    const reader = new FileReader();
    reader.onload = e => {
      imagePreview.src = e.target.result;
      hide(dropZone);
      show(imagePreviewContainer);
      hide(resultContainer);
    };
    reader.readAsDataURL(file);
  }
}

['dragenter','dragover'].forEach(evt => {
  dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.add('ring-2','ring-green-400'); });
});
['dragleave','drop'].forEach(evt => {
  dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.remove('ring-2','ring-green-400'); });
});
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  const dt = e.dataTransfer;
  if (dt && dt.files && dt.files[0]){
    fileInput.files = dt.files;
    handleFileSelect();
  }
});

/* ---------------- Remove ---------------- */
removeImageButton.addEventListener('click', () => {
  fileInput.value = '';
  show(dropZone);
  hide(imagePreviewContainer);
  hide(resultContainer);
});

/* ---------------- Analysis ---------------- */
analyzeButton.addEventListener('click', async () => {
  if (!fileInput.files[0]) return alert(t('ui.upload', 'Select an image first!'));
  hide(resultContainer);
  show(loader);

  const formData = new FormData();
  formData.append('file', fileInput.files[0]);

  try{
    const res = await fetch(`${API_ENDPOINT}?lang=${currentLang}`, { method: 'POST', body: formData });
    if (!res.ok) throw new Error('Server error: ' + res.status);
    const data = await res.json();
    console.log("Server response:", data);
    hide(loader);
    show(resultContainer);

    lastServerResult = data; // store raw result for re-localization

    renderResultLocalized(data);

    // Save to local history (localized name will be saved inside renderResultLocalized)
  }catch(err){
    hide(loader);
    console.error(err);
    alert('Error analyzing image. Make sure backend is running and CORS allows requests.');
  }
});

function renderResultLocalized(serverData) {
  // serverData should include diseaseName and diseaseName_simplified
  const serverIsHealthy = serverData.isHealthy === true;
  const serverDiseaseName = serverData.diseaseName || (serverIsHealthy ? 'Healthy' : 'Unknown');
  const serverSimplified = serverData.diseaseName_simplified || serverDiseaseName;
  const serverConfidence = typeof serverData.confidence === 'number' ? (serverData.confidence * 100).toFixed(1) : (serverData.confidence || 'N/A');
  const serverDescription = serverData.description || '';
  const serverRecommendations = Array.isArray(serverData.recommendations) ? serverData.recommendations : [];

  // Try to find translation using simplified key first, then full name, then case-insensitive
  const classPack = (translations[currentLang] && translations[currentLang].classes) || {};
  let localizedName = null;
  let localizedDescription = null;
  let localizedRecommendations = null;

  if (serverSimplified in classPack) {
    const c = classPack[serverSimplified];
    localizedName = c.name || serverDiseaseName;
    localizedDescription = c.description || serverDescription;
    localizedRecommendations = Array.isArray(c.recommendations) ? c.recommendations : serverRecommendations;
  } else if (serverDiseaseName in classPack) {
    const c = classPack[serverDiseaseName];
    localizedName = c.name || serverDiseaseName;
    localizedDescription = c.description || serverDescription;
    localizedRecommendations = Array.isArray(c.recommendations) ? c.recommendations : serverRecommendations;
  } else {
    // case-insensitive search
    const lower = serverSimplified.toLowerCase();
    for (const k of Object.keys(classPack)) {
      if (k.toLowerCase() === lower) {
        const c = classPack[k];
        localizedName = c.name || serverDiseaseName;
        localizedDescription = c.description || serverDescription;
        localizedRecommendations = Array.isArray(c.recommendations) ? c.recommendations : serverRecommendations;
        break;
      }
    }
  }

  // fallback to generic localized messages
  if (!localizedName) {
    localizedName = serverDiseaseName;
    if (serverIsHealthy) {
      localizedDescription = t('generic.healthy.description', serverDescription || 'The plant looks healthy.');
      localizedRecommendations = t('generic.healthy.recommendations', null) || serverRecommendations;
    } else {
      localizedDescription = t('generic.disease.description', serverDescription || 'Predicted disease detected.');
      localizedRecommendations = t('generic.disease.recommendations', null) || serverRecommendations;
    }
  }

  if (!Array.isArray(localizedRecommendations)) localizedRecommendations = serverRecommendations;

  // Render
  resultContent.innerHTML = `
    <div class="flex items-center justify-between">
      <h3 class="text-xl font-bold ${serverIsHealthy ? 'text-green-600' : 'text-red-600'}">${localizedName}</h3>
      <div class="text-sm text-gray-600">${t('ui.confidence','Confidence')}: ${serverConfidence}%</div>
    </div>
    <p class="mt-2 text-sm text-gray-700">${localizedDescription}</p>
    <h4 class="font-semibold mt-3">${t('ui.recommendations','Recommendations')}:</h4>
    <ul class="list-disc list-inside text-sm">${localizedRecommendations.map(r => `<li>‚úÖ ${r}</li>`).join('')}</ul>
  `;

  // Save to local history (store localized name + localized recommendations)
  saveHistory({
    timestamp: new Date().toISOString(),
    diseaseName: localizedName,
    confidence: serverConfidence,
    recommendations: localizedRecommendations
  });
}

/* ---------------- History (localStorage) ---------------- */
function saveHistory(item){
  const key = 'plantai_history_v1';
  const hist = JSON.parse(localStorage.getItem(key) || '[]');
  hist.unshift(item);
  localStorage.setItem(key, JSON.stringify(hist.slice(0,50))); // keep last 50
  renderHistory();
}

function renderHistory(){
  const key = 'plantai_history_v1';
  const hist = JSON.parse(localStorage.getItem(key) || '[]');
  if (!hist.length){
    historyList.innerHTML = t('ui.noHistory','No history yet.');
    return;
  }
  historyList.innerHTML = hist.map(h => {
    const tstamp = new Date(h.timestamp).toLocaleString();
    return `<div class="p-3 border-b last:border-b-0"><div class="flex justify-between"><div class="font-medium">${h.diseaseName}</div><div class="text-xs text-gray-500">${tstamp}</div></div><div class="text-xs text-gray-600">${t('ui.confidence','Confidence')}: ${h.confidence}%</div></div>`;
  }).join('');
}

openHistoryBtn && openHistoryBtn.addEventListener('click', () => {
  window.location.hash = '#history';
  renderHistory();
});

/* ---------------- Download report ---------------- */
downloadReportBtn && downloadReportBtn.addEventListener('click', () => {
  const latest = JSON.parse(localStorage.getItem('plantai_history_v1') || '[]')[0];
  if (!latest) return alert(t('ui.noResult','No analysis result to download.'));
  const content = `PlantAI Report\nDate: ${new Date(latest.timestamp).toLocaleString()}\nDisease: ${latest.diseaseName}\nConfidence: ${latest.confidence}%\n${t('ui.recommendations','Recommendations')}:\n- ${latest.recommendations ? latest.recommendations.join('\n- ') : 'None'}`;
  const blob = new Blob([content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `plantai_report_${new Date(latest.timestamp).toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

/* ---------------- Smooth scroll for nav anchors ---------------- */
document.querySelectorAll('a[href^="#"]').forEach(a => {
  a.addEventListener('click', e => {
    const target = document.querySelector(a.getAttribute('href'));
    if (target){ e.preventDefault(); target.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
  });
});

/* ---------------- Language change handler & initial render ---------------- */
langSelect.addEventListener('change', () => {
  currentLang = langSelect.value;
  localStorage.setItem('plantai_lang', currentLang);
  applyTranslationsToUI();
  renderHistory();
  // if we've got a last result, re-render it localized in the new language
  if (lastServerResult) {
    renderResultLocalized(lastServerResult);
  }
});

window.addEventListener("DOMContentLoaded", () => {
  applyTranslationsToUI();
  renderHistory();
});
</script>
</body>
</html>
